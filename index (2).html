<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Generator – HTML</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{ --border:#e5e7eb; --txt:#111827; --muted:#6b7280; --bg:#f8fafc; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--txt); background:var(--bg); }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 1px 2px rgba(0,0,0,.06); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .row-4{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px; }
    .row-3{ display:grid; grid-template-columns:2fr 1fr 1fr; gap:12px; }
    .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .input{ width:100%; border:1px solid var(--border); border-radius:12px; padding:8px 12px; background:#fff; }
    .textarea{ width:100%; border:1px solid var(--border); border-radius:12px; padding:8px 12px; resize:vertical; }
    .btn{ padding:8px 12px; border-radius:12px; background:#111; color:#fff; border:1px solid transparent; cursor:pointer; }
    .btn:hover{ opacity:.92; }
    .btn.ghost{ background:#fff; color:#111; border-color:var(--border); }
    .btn.small{ padding:6px 10px; border-radius:10px; font-size:13px; }
    .muted{ color:var(--muted); font-size:12px; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ border-top:1px solid var(--border); padding:8px; text-align:left; vertical-align:top; }
    thead th{ background:#f1f5f9; }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden{ display:none !important; }
    .right{ text-align:right; }
    .center{ text-align:center; }
    .headline{ font-size:20px; font-weight:600; margin:0 0 12px; }
    .title{ font-size:24px; font-weight:700; margin:0 0 12px; }
    .link{ color:#2563eb; text-decoration:none; }
    .link:hover{ text-decoration:underline; }
    .chip{ border:1px dashed var(--border); padding:8px; border-radius:12px; font-size:12px; color:#334155; background:#f8fafc; }
    .nowrap{ white-space:nowrap; }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:50; }
    .modal{ background:#fff; width:min(680px, 94vw); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); border:1px solid var(--border); }
    .modal header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); }
    .modal .content{ padding:16px 18px; }
    .modal footer{ display:flex; justify-content:flex-end; gap:8px; padding:16px 18px; border-top:1px solid var(--border); }

    /* Printable header layout */
    #printArea .print-header{
      display:grid; grid-template-columns:100px 1fr 100px; align-items:center;
      border-bottom:2px solid var(--border); padding-bottom:8px; margin-bottom:8px;
    }
    #printArea .ph-left{ display:flex; justify-content:flex-start; }
    #printArea .ph-center{ text-align:center; }
    #printArea #sup-name{ font-size:140%; font-weight:700; margin:2px 0; }
    #printArea .print-items th, #printArea .print-items td{ font-size:75%; } /* smaller item rows in PDF */

    .hsn-summary{ font-size:60%; } /* HSN summary ~half font size */

    .signature-img{ max-height: 60px; max-width: 150px; display: block; margin-left: auto; }
    .signature-thumbnail{ height:48px; width:120px; object-fit:contain; border:1px solid var(--border); cursor:pointer; }


    @media print{
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position:absolute; left:0; top:0; width:100%; }
      .no-print{ display:none !important; }
      @page { size:A4; margin:10mm; }
    }
  </style>
</head>
<body>
  <datalist id="desc-list"></datalist>
  <datalist id="hsn-list"></datalist>
  <datalist id="tax-rate-list"></datalist>
  <datalist id="unit-list"></datalist>
  <datalist id="party-list"></datalist>

  <div id="view-login" class="container">
    <div class="card" style="max-width:480px; margin:60px auto;">
      <h1 class="title center">Invoice Generator – Login</h1>
      <div class="row">
        <div>
          <label class="muted">Login ID</label>
          <input id="login-user" class="input" placeholder="Login ID" autocomplete="username" autocapitalize="none" spellcheck="false" />
        </div>
        <div>
          <label class="muted">Password</label>
          <input id="login-pass" class="input" type="password" placeholder="Password" autocomplete="current-password" />
        </div>
      </div>
      <p id="login-err" class="muted" style="color:#dc2626; margin:8px 0 0; display:none;">Invalid credentials.</p>
      <div style="margin-top:12px;">
        <button class="btn" type="button" onclick="login()" style="width:100%">Login</button>
      </div>
    </div>
  </div>

  <div id="view-suppliers" class="container hidden">
    <div class="toolbar" style="justify-content:space-between; margin-bottom:10px;">
      <h2 class="headline">Seller / Suppliers</h2>
      <div class="toolbar">
        <input id="supplier-search" class="input" placeholder="Search suppliers..." oninput="renderSuppliers()" style="width:200px;" />
        <button class="btn" onclick="openSupplierModal()">Add</button>
        <button class="btn ghost" onclick="downloadSupplierTemplate()">Download Import Template</button>
        <label class="btn ghost">
          Import Bulk (Excel)
          <input id="supplier-import" type="file" accept=".xlsx,.xls" class="hidden" onchange="importSuppliers(this.files[0]); this.value=''"/>
        </label>
        <button id="suppliers-delete-selected" class="btn" onclick="deleteSelectedSuppliers()" disabled>Delete Selected</button>
      </div>
    </div>
    <div class="card">
      <div class="chip">Click a supplier name to continue to invoice</div>
      <div style="overflow:auto;">
        <table id="suppliers-table">
          <thead>
            <tr>
              <th class="center" style="width:48px"><input type="checkbox" id="suppliers-checkall"/></th>
              <th>Name</th>
              <th>GST No.</th>
              <th>State</th>
              <th>Address</th>
              <th>Pincode</th>
              <th class="right" style="width:190px;">Actions</th>
            </tr>
          </thead>
          <tbody id="suppliers-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="view-invoice" class="container hidden">
    <div class="card no-print" style="margin-bottom:12px; padding:12px;">
        <div class="toolbar" style="justify-content:space-between;">
            <div>
                <strong>Supplier:</strong> <span id="current-supplier-name"></span>
                <span class="muted" style="margin-left:8px;" id="current-supplier-gst"></span>
            </div>
            <div id="current-supplier-address" class="muted"></div>
        </div>
    </div>
    <div class="toolbar no-print" style="justify-content:space-between; margin-bottom:10px;">
      <button class="btn ghost" onclick="routeTo('suppliers')">← Back</button>
      <div class="toolbar">
        <button id="btn-supplier-dash" class="btn" onclick="routeTo('supplier-dashboard')">Supplier Dashboard</button>
        <button class="btn" onclick="routeTo('parties')">Party Dashboard</button>
        <button class="btn" onclick="routeTo('templates')">Templates</button>
        <button class="btn" onclick="routeTo('reports')">Reports</button>
        <button id="btn-save-edit" class="btn hidden" onclick="saveEditedInvoice()">Save Changes</button>
        <button id="btn-generate" class="btn ghost" onclick="generateInvoice()">Generate Invoice</button>
        <button class="btn ghost" onclick="downloadCurrentInvoiceExcel()">Download Excel</button>
      </div>
    </div>

    <div class="card no-print">
      <h2 class="headline">Invoice Details</h2>
      <div class="row-4">
        <div>
          <label class="muted">Invoice No.</label>
          <input id="inv-no" class="input" />
        </div>
        <div>
          <label class="muted">Dated</label>
          <input id="inv-date" type="date" class="input" />
        </div>
        <div>
          <label class="muted">&nbsp;</label>
          <button class="btn" style="width:100%" onclick="openMoreDetails()">More Details</button>
        </div>
      </div>

      <div class="row-2" style="margin-top:12px;">
        <div>
          <h3 class="headline" style="font-size:16px;">Billed to</h3>
          <div>
            <label class="muted">Party name</label>
            <input id="bill-party" class="input" list="party-list" onchange="selectBilledParty(this.value)" placeholder="Type or select a party"/>
          </div>
          <div style="margin-top:8px;">
            <label class="muted">Party Address</label>
            <textarea id="bill-address" class="textarea" rows="2" disabled></textarea>
          </div>
          <div class="row-2" style="margin-top:8px;">
            <div>
              <label class="muted">Party GST No.</label>
              <input id="bill-gst" class="input" disabled />
            </div>
            <div>
              <label class="muted">Party PAN</label>
              <input id="bill-pan" class="input" disabled />
            </div>
          </div>
          <div class="row-2" style="margin-top:8px;">
            <div>
              <label class="muted">Pincode</label>
              <input id="bill-pin" class="input" disabled />
            </div>
            <div>
              <label class="muted">State</label>
              <input id="bill-state" class="input" disabled />
            </div>
          </div>
        </div>
        <div>
          <div class="toolbar" style="justify-content:space-between;">
            <h3 class="headline" style="font-size:16px;">Shipped to</h3>
            <label class="muted"><input type="checkbox" id="ship-enable" onchange="toggleShip()"/> Enable</label>
          </div>
          <div>
            <label class="muted">Name</label>
            <input id="ship-name" class="input" disabled />
          </div>
          <div style="margin-top:8px;">
            <label class="muted">Address</label>
            <textarea id="ship-address" class="textarea" rows="2" disabled></textarea>
          </div>
          <div class="row-2" style="margin-top:8px;">
            <div>
              <label class="muted">GSTIN</label>
              <input id="ship-gst" class="input" disabled />
            </div>
            <div>
              <label class="muted">PAN</label>
              <input id="ship-pan" class="input" disabled />
            </div>
          </div>
          <div class="row-2" style="margin-top:8px;">
            <div>
              <label class="muted">Pincode</label>
              <input id="ship-pin" class="input" disabled />
            </div>
            <div>
              <label class="muted">State</label>
              <input id="ship-state" class="input" disabled />
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:18px;">
        <div class="toolbar" style="justify-content:space-between; margin-bottom:6px;">
          <h3 class="headline" style="font-size:16px;">Items</h3>
          <div class="toolbar">
            <label class="btn ghost">Add Bulk Entries
              <input id="items-import" type="file" accept=".xlsx,.xls" class="hidden" onchange="importItems(this.files[0]); this.value=''"/>
            </label>
            <button class="btn ghost" onclick="downloadItemsTemplate()">Download Bulk Import template</button>
          </div>
        </div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th class="center" style="width:50px">S.N.</th>
                <th>Description of Goods</th>
                <th>HSN/SAC Code</th>
                <th>Tax Rate (%)</th>
                <th>Qty.</th>
                <th>Unit</th>
                <th>List Price</th>
                <th>Discount %</th>
                <th>Price</th>
                <th>Amount (₹)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="items-tbody"></tbody>
            <tfoot>
              <tr>
                <td colspan="4" class="right"><strong>Totals:</strong></td>
                <td id="sum-qty" class="right">0</td>
                <td></td><td></td><td></td>
                <td class="right"><span class="muted">—</span></td>
                <td id="sum-amount" class="right">₹ 0.00</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="11" class="right">
                  <button class="btn" onclick="addItemRow()">Add Row</button>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="row-3" style="margin-top:16px; align-items:start;">
        <div style="grid-column:1 / span 2;">
          <label class="muted">HSN Summary</label>
          <div class="card hsn-summary" id="hsn-summary-card" style="padding:0; margin-bottom:10px;">
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>HSN/SAC</th>
                    <th>Tax Rate (%)</th>
                    <th class="right">Taxable Amt.</th>
                    <th class="right">CGST Amt.</th>
                    <th class="right">SGST Amt.</th>
                    <th class="right">Total Tax</th>
                  </tr>
                </thead>
                <tbody id="hsn-summary-body"></tbody>
              </table>
            </div>
          </div>

          <label class="muted">Terms & Conditions</label>
          <textarea id="inv-terms" class="textarea" rows="4">E.& O.E.
1. Goods once sold will not be taken back.
2. Interest @ 18% p.a. will be charged if the payment is not made within the stipulated time.</textarea>
        </div>

        <div class="card">
          <div class="toolbar" style="justify-content:space-between"><span>Taxable Amount</span><span id="tot-taxable">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between"><span>Add : CGST</span><span id="tot-cgst">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between"><span>Add : SGST</span><span id="tot-sgst">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between"><span>Add : IGST</span><span id="tot-igst">₹ 0.00</span></div>
          <hr/>
          <div class="toolbar" style="justify-content:space-between; font-weight:700;"><span>Grand Total</span><span id="tot-grand">₹ 0.00</span></div>
        </div>
      </div>
    </div>

    <div id="printArea" class="card" style="margin-top:16px;">
      <div class="print-header">
        <div class="ph-left">
          <img id="sup-logo" src="" alt="logo" style="height:64px; width:64px; object-fit:contain; border:1px solid var(--border); display:none;"/>
        </div>
        <div class="ph-center">
          <div class="center" style="font-weight:600; text-transform:uppercase;">TAX INVOICE</div>
          <div id="sup-name">Your Company</div>
          <div id="sup-addr" class="muted"></div>
          <div id="sup-gst" class="muted"></div>
        </div>
        <div></div>
      </div>

      <div class="row-4" style="margin-top:8px; font-size:14px;">
        <div>Invoice No.: <b id="p-invno"></b></div>
        <div>Dated: <b id="p-date"></b></div>
        <div>Reverse Charge: <b id="p-rc"></b></div>
        <div>GR/RR No.: <b id="p-gr"></b></div>
        <div>Transport: <b id="p-transport"></b></div>
        <div>Vehicle No.: <b id="p-veh"></b></div>
        <div>Station: <b id="p-station"></b></div>
        <div>E-Way Bill No.: <b id="p-eway"></b></div>
      </div>

      <div class="row-2" style="margin-top:8px; font-size:14px;">
        <div class="card">
          <div style="font-weight:600;">Billed to :</div>
          <pre id="p-bill" style="white-space:pre-wrap; margin:6px 0 0;"></pre>
        </div>
        <div class="card">
          <div style="font-weight:600;">Shipped to :</div>
          <pre id="p-ship" style="white-space:pre-wrap; margin:6px 0 0;"></pre>
        </div>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table class="print-items">
          <thead>
            <tr>
              <th class="center" style="width:50px">S.N.</th>
              <th>Description of Goods</th>
              <th>HSN/SAC Code</th>
              <th>Tax Rate</th>
              <th>Qty.</th>
              <th>Unit</th>
              <th>List Price</th>
              <th>Discount</th>
              <th>Price</th>
              <th class="right">Amount(₹)</th>
            </tr>
          </thead>
          <tbody id="p-items"></tbody>
        </table>
      </div>

      <div class="card hsn-summary" style="margin-top:10px;">
        <div style="font-weight:600;">HSN Summary</div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>HSN/SAC</th>
                <th>Tax Rate (%)</th>
                <th class="right">Taxable Amt.</th>
                <th class="right">CGST Amt.</th>
                <th class="right">SGST Amt.</th>
                <th class="right">Total Tax</th>
              </tr>
            </thead>
            <tbody id="p-hsn-summary"></tbody>
          </table>
        </div>
      </div>

      <div class="row-2" style="margin-top:8px;">
        <div></div>
        <div>
          <div class="toolbar" style="justify-content:space-between"><span>Taxable Amount</span><span id="p-taxable">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between"><span>Add ; CGST</span><span id="p-cgst">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between"><span>Add ; SGST</span><span id="p-sgst">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between"><span>Add ; IGST</span><span id="p-igst">₹ 0.00</span></div>
          <div class="toolbar" style="justify-content:space-between; font-weight:700; border-top:1px solid var(--border); padding-top:6px;"><span>Grand Total</span><span id="p-grand">₹ 0.00</span></div>
        </div>
      </div>

      <div style="margin-top:8px;">Rupees <span id="p-words"></span> Only</div>

      <div class="row-2" style="margin-top:10px;">
        <div class="card">
          <div style="font-weight:600;">Terms & Conditions</div>
          <pre id="p-terms" style="white-space:pre-wrap; margin:6px 0 0;"></pre>
        </div>
        <div class="card" style="display:flex; flex-direction:column; justify-content:space-between;">
          <div class="right">For <span id="p-supname2">Your Company</span></div>
          <div style="margin-top:10px;">
              <img id="p-signature" class="signature-img" style="display:none;" />
              <div class="right" style="margin-top:8px;">Authorised Signatory</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="view-reports" class="container hidden">
    <div class="toolbar" style="justify-content:space-between; margin-bottom:10px;">
      <button class="btn ghost" onclick="routeTo('invoice')">← Back</button>
      <div class="toolbar">
        <label class="muted">From</label><input id="report-from" class="input" type="date" onchange="renderReports()" />
        <label class="muted">To</label><input id="report-to" class="input" type="date" onchange="renderReports()" />
        <input id="report-search" class="input" placeholder="Search party name..." oninput="renderReports()" />
        <button class="btn ghost" onclick="clearReportFilters()">Clear Filters</button>
        <button id="btn-zip" class="btn" onclick="downloadSelectedZip()" disabled>Download Selected (ZIP)</button>
        <button class="btn" onclick="downloadReportsExcel()">Download Excel</button>
      </div>
    </div>
    <div class="card" style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th class="center" style="width:42px"><input type="checkbox" id="reports-checkall" onchange="toggleSelectAllReports(this)"/></th>
            <th>Invoice Number</th>
            <th>Billed Party Name</th>
            <th>GST rate</th>
            <th>HSN</th>
            <th>Taxable Amount</th>
            <th>Tax Amount</th>
            <th>Date</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody id="reports-tbody"></tbody>
      </table>
    </div>
  </div>

  <div id="view-parties" class="container hidden">
    <div class="toolbar" style="justify-content:space-between; margin-bottom:10px;">
        <button class="btn ghost" onclick="routeTo('invoice')">← Back to Invoice</button>
        <div class="toolbar">
            <button class="btn" onclick="openPartyModal()">Add a Party</button>
            <button class="btn ghost" onclick="downloadPartyTemplate()">Download Template</button>
            <label class="btn ghost">Bulk Import Party
                <input id="party-import" type="file" accept=".xlsx,.xls" class="hidden" onchange="importParties(this.files[0]); this.value=''"/>
            </label>
        </div>
    </div>
    <div class="card">
        <h2 class="headline">Manage Parties</h2>
        <div style="overflow:auto;">
            <table id="parties-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>GST No.</th>
                        <th>State</th>
                        <th>Address</th>
                        <th class="right">Actions</th>
                    </tr>
                </thead>
                <tbody id="parties-tbody"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="view-templates" class="container hidden">
    <div class="toolbar" style="margin-bottom:10px;">
        <button class="btn ghost" onclick="routeTo('invoice')">← Back to Invoice</button>
    </div>
    <div class="card">
        <h2 class="headline">Download Templates</h2>
        <div class="toolbar">
            <button class="btn" onclick="downloadPartyTemplate()">Download Party Import Template</button>
            <button class="btn" onclick="downloadSupplierTemplate()">Download Supplier Import Template</button>
            <button class="btn" onclick="downloadItemsTemplate()">Download Invoice Items Import Template</button>
        </div>
    </div>
  </div>

  <div id="view-supplier-dashboard" class="container hidden">
      <div class="toolbar" style="margin-bottom:10px;">
          <button class="btn ghost" onclick="routeTo('invoice')">← Back to Invoice</button>
      </div>
      <div class="card">
          <h2 class="headline">Supplier Dashboard</h2>
          <h3 class="headline" style="font-size:16px;">Manage Signatures</h3>
          <p class="muted">Upload up to 4 signatures (JPG/PNG). They will appear above the "Authorised Signatory" text on the invoice.</p>
          <div class="row-2">
              <div>
                  <label class="muted">Add New Signature</label>
                  <input id="s-signature-upload" type="file" accept="image/png,image/jpeg" onchange="addSignature(this.files[0])"/>
              </div>
              <div>
                  <label class="muted">Default Signature for Invoices</label>
                  <select id="s-signature-default" class="input" onchange="setDefaultSignature(this.value)"></select>
              </div>
          </div>
          <div id="s-signatures-container" class="toolbar" style="margin-top:16px; border-top:1px solid var(--border); padding-top:16px;">
              </div>
      </div>
  </div>

  <div id="modal-supplier" class="modal-backdrop hidden">
    <div class="modal">
      <header>
        <div class="headline" style="margin:0;">Add Seller/Supplier</div>
        <button class="btn ghost small" onclick="closeSupplierModal()">✕</button>
      </header>
      <div class="content">
        <div class="row-2">
          <div>
            <label class="muted">Name *</label>
            <input id="s-name" class="input" />
          </div>
          <div>
            <label class="muted">GST No.</label>
            <input id="s-gst" class="input" maxlength="15" oninput="this.value=this.value.toUpperCase()" placeholder="15-char GSTIN" />
            <div class="muted">Format: 2 digits, 5 letters, 4 digits, 4 alphanumeric</div>
          </div>
        </div>
        <div class="row-2" style="margin-top:8px;">
          <div>
            <label class="muted">State *</label>
            <select id="s-state" class="input"></select>
          </div>
          <div>
            <label class="muted">Pincode *</label>
            <input id="s-pin" class="input" maxlength="6" />
          </div>
        </div>
        <div style="margin-top:8px;">
          <label class="muted">Address *</label>
          <textarea id="s-addr" class="textarea" rows="2"></textarea>
        </div>
        <div style="margin-top:8px;">
          <label class="muted">Small Box Logo (JPG/JPEG/PNG)</label>
          <input id="s-logo" type="file" accept="image/png,image/jpeg" />
          <img id="s-logo-preview" alt="logo" style="display:none; height:48px; width:48px; object-fit:contain; border:1px solid var(--border); margin-top:6px;"/>
        </div>
      </div>
      <footer>
        <button class="btn ghost" onclick="closeSupplierModal()">Cancel</button>
        <button class="btn" onclick="saveSupplier()">Save</button>
      </footer>
    </div>
  </div>

  <div id="modal-party" class="modal-backdrop hidden" data-edit="">
    <div class="modal">
      <header>
        <div id="party-modal-title" class="headline" style="margin:0;">Add Party</div>
        <button class="btn ghost small" onclick="closePartyModal()">✕</button>
      </header>
      <div class="content">
        <div class="row-2">
          <div>
            <label class="muted">Party name *</label>
            <input id="p-name" class="input" />
          </div>
          <div>
            <label class="muted">Party PAN</label>
            <input id="p-pan" class="input" oninput="this.value=this.value.toUpperCase()" />
          </div>
        </div>
        <div style="margin-top:8px;">
          <label class="muted">Party Address *</label>
          <textarea id="p-addr" class="textarea" rows="2"></textarea>
        </div>
        <div class="row-2" style="margin-top:8px;">
          <div>
            <label class="muted">Party GST No.</label>
            <input id="p-gst" class="input" maxlength="15" oninput="partyGSTChanged(this.value)" />
          </div>
          <div>
            <label class="muted">Pincode *</label>
            <input id="p-pin" class="input" maxlength="6" />
          </div>
        </div>
        <div class="row-2" style="margin-top:8px;">
          <div>
            <label class="muted">State *</label>
            <select id="p-state" class="input"></select>
          </div>
          <div></div>
        </div>
      </div>
      <footer>
        <button class="btn ghost" onclick="closePartyModal()">Cancel</button>
        <button class="btn" onclick="saveParty()">Save</button>
      </footer>
    </div>
  </div>

  <div id="modal-more" class="modal-backdrop hidden">
    <div class="modal">
      <header>
        <div class="headline" style="margin:0;">More Details</div>
        <button class="btn ghost small" onclick="closeMoreDetails()">✕</button>
      </header>
      <div class="content">
        <div class="row-2">
          <div>
            <label class="muted">Reverse Charge</label>
            <input id="m-rc" class="input" />
          </div>
          <div>
            <label class="muted">GR/RR No.</label>
            <input id="m-gr" class="input" />
          </div>
        </div>
        <div class="row-2" style="margin-top:8px;">
          <div>
            <label class="muted">Transport</label>
            <input id="m-transport" class="input" />
          </div>
          <div>
            <label class="muted">Vehicle No.</label>
            <input id="m-veh" class="input" />
          </div>
        </div>
        <div class="row-2" style="margin-top:8px;">
          <div>
            <label class="muted">Station</label>
            <input id="m-station" class="input" />
          </div>
          <div>
            <label class="muted">E-Way Bill No.</label>
            <input id="m-eway" class="input" />
          </div>
        </div>
      </div>
      <footer>
        <button class="btn" onclick="applyMoreDetails()">Done</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const STATES = ["Andaman & Nicobar Islands","Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chandigarh","Chhattisgarh","Dadra & Nagar Haveli & Daman & Diu","Daman & Diu","Delhi","Foreign Country","Goa","Gujarat","Haryana","Himachal Pradesh","Jammu & Kashmir","Jharkhand","Karnataka","Kerala","Ladakh","Lakshdweep","Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Other Territory","Puducherry","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal"];
    const GST_REGEX = /^\d{2}[A-Za-z]{5}\d{4}[A-Za-z0-9]{4}$/;
    const currency = n => (isNaN(n)? "0.00" : Number(n).toLocaleString('en-IN',{minimumFractionDigits:2, maximumFractionDigits:2}));
    const pad2 = n => String(n).padStart(2,'0');
    const store = { get:(k,f)=>{ try{ const r = localStorage.getItem(k); return r? JSON.parse(r) : f; }catch{ return f; } }, set:(k,v)=> localStorage.setItem(k, JSON.stringify(v)) };
    const toWords = (n)=>{ try{ const a=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"], b=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"]; const inW=x=> x<20?a[x]:`${b[Math.floor(x/10)]}${a[x%10]?" "+a[x%10]:""}`; const sec=(x,l)=>!x?"":(x<100?`${inW(x)} ${l}`:`${a[Math.floor(x/100)]} Hundred${x%100?" "+inW(x%100):""} ${l}`); n=Math.round(n); if(n===0) return "Zero"; let c=Math.floor(n/1e7); n%=1e7; let l=Math.floor(n/1e5); n%=1e5; let t=Math.floor(n/1e3); n%=1e3; return `${sec(c,'Crore')} ${sec(l,'Lakh')} ${sec(t,'Thousand')} ${sec(n,'')}`.replace(/\s+/g,' ').trim(); }catch{ return ""; } };
    const extractPANFromGST = gst => (gst && /^.{12}/.test(gst) ? gst.slice(2,12).toUpperCase() : "");
    const na = v => { const s = String(v==null? '' : v).trim(); return s ? s : 'NA'; };
    const triggerBlobDownload = (blob, filename)=>{
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
    const uid = () => 's_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
    const formatDate = (isoDate) => {
        if (!isoDate || typeof isoDate !== 'string') return '';
        try {
            const [y, m, d] = isoDate.split('-');
            return `${d}-${m}-${y}`;
        } catch {
            return isoDate; // fallback
        }
    };

    // ===== App State (Per‑Supplier “file space”) =====
    let suppliers = store.get('suppliers', []);
    suppliers.forEach(s=>{ if(!s.id){ s.id = uid(); }});
    store.set('suppliers', suppliers);

    // Scoped by supplier.id
    let scopeKey = null; // suppliers[currentSupplierIndex].id
    let parties = [];     // parties:<scopeKey>
    let invoices = [];    // invoices:<scopeKey>
    let reports = [];     // reports:<scopeKey>
    let descriptions = [];// descriptions:<scopeKey>
    let hsns = [];        // hsns:<scopeKey>
    let taxRates = [];    // taxRates:<scopeKey>
    let units = [];       // units:<scopeKey>
    let invSeq = 1;       // invSeq:<scopeKey>
    let currentSupplierIndex = -1;
    let invoice = null;
    let editingInvoiceNo = null;

    const scopeK = (suffix)=> `${suffix}:${scopeKey}`;
    function loadScope(){
      parties  = store.get(scopeK('parties'), []);
      invoices = store.get(scopeK('invoices'), []);
      reports  = store.get(scopeK('reports'), []);
      invSeq   = store.get(scopeK('invSeq'), 1);
      descriptions = store.get(scopeK('descriptions'), []);
      hsns = store.get(scopeK('hsns'), []);
      taxRates = store.get(scopeK('taxRates'), [5, 12, 18, 28]);
      units = store.get(scopeK('units'), ["Bag", "box", "Bucket", "bunches", "Dozen", "gm", "Gms.", "Hanger", "jar", "kg", "Kgs.", "Metre", "N.A.", "nos", "Outer", "Packet", "Patti", "pcs", "Pcs.", "Tonne", "Unit", "Units"]);
    }
    function saveScope(){
      store.set(scopeK('parties'), parties);
      store.set(scopeK('invoices'), invoices);
      store.set(scopeK('reports'), reports);
      store.set(scopeK('invSeq'), invSeq);
      store.set(scopeK('descriptions'), descriptions);
      store.set(scopeK('hsns'), hsns);
      store.set(scopeK('taxRates'), taxRates);
      store.set(scopeK('units'), units);
    }
    function updateDatalists() {
        const unique = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a-b);
        document.getElementById('desc-list').innerHTML = unique(descriptions).map(v => `<option value="${v}"></option>`).join('');
        document.getElementById('hsn-list').innerHTML = unique(hsns).map(v => `<option value="${v}"></option>`).join('');
        document.getElementById('tax-rate-list').innerHTML = unique(taxRates).map(v => `<option value="${v}"></option>`).join('');
        document.getElementById('unit-list').innerHTML = unique(units).map(v => `<option value="${v}"></option>`).join('');
    }

    // ===== Routing =====
    function routeTo(view){
      document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
      document.getElementById('view-'+view).classList.remove('hidden');
      if(view==='suppliers') renderSuppliers();
      if(view==='invoice') renderInvoicePage();
      if(view==='reports') renderReports();
      if(view==='parties') renderParties();
      if(view==='supplier-dashboard') renderSupplierDashboard();
    }

    // ===== Login =====
    function login(){
      const u = (document.getElementById('login-user').value||'').trim().toLowerCase();
      const p = (document.getElementById('login-pass').value||'').trim().toLowerCase();
      const ok = (u==='nitin' && p==='nitin');
      document.getElementById('login-err').style.display = ok? 'none' : 'block';
      if(ok){ sessionStorage.setItem('ok','1'); routeTo('suppliers'); }
    }
    ['login-user','login-pass'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ login(); } });
    });

    // ===== Init dropdowns =====
    (function initSelects(){
      document.getElementById('s-state').innerHTML = '<option value="">Select state</option>' + STATES.map(s=>`<option>${s}</option>`).join('');
      document.getElementById('p-state').innerHTML = '<option value="">Select state</option>' + STATES.map(s=>`<option>${s}</option>`).join('');
    })();

    // ===== Suppliers =====
    document.getElementById('suppliers-checkall').addEventListener('change', e=>{
      const boxes = document.querySelectorAll('.supplier-check');
      boxes.forEach(b=>{ b.checked = e.target.checked; });
      updateSuppliersBulkBtn();
    });
    function updateSuppliersBulkBtn(){
      const any = Array.from(document.querySelectorAll('.supplier-check')).some(b=>b.checked);
      document.getElementById('suppliers-delete-selected').disabled = !any;
    }
    function renderSuppliers(){
      const q = (document.getElementById('supplier-search').value || '').trim().toLowerCase();
      const filteredSuppliers = suppliers.filter(s => (s.name || '').toLowerCase().includes(q) || (s.gst || '').toLowerCase().includes(q) );
      const body = document.getElementById('suppliers-tbody'); body.innerHTML = '';

      filteredSuppliers.forEach(s => {
        const originalIndex = suppliers.findIndex(sup => sup.id === s.id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center"><input type="checkbox" class="supplier-check" data-i="${originalIndex}"></td>
          <td><a href="#" class="link" data-i="${originalIndex}">${s.name}</a></td>
          <td class="muted">${s.gst||''}</td>
          <td>${s.state||''}</td>
          <td>${s.address||''}</td>
          <td>${s.pincode||''}</td>
          <td class="right">
            <button class="btn ghost small" data-edit="${originalIndex}">Edit</button>
            <button class="btn ghost small" data-del="${originalIndex}" style="color:#dc2626;">Delete</button>
          </td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('a.link').forEach(a=> a.addEventListener('click', ev=>{ ev.preventDefault(); enterInvoice(+a.dataset.i); }));
      body.querySelectorAll('button[data-edit]').forEach(b=> b.addEventListener('click', ()=> openSupplierModal(+b.dataset.edit)));
      body.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', ()=> { suppliers.splice(+b.dataset.del,1); store.set('suppliers',suppliers); renderSuppliers(); }));
      body.querySelectorAll('.supplier-check').forEach(b=> b.addEventListener('change', updateSuppliersBulkBtn));
      updateSuppliersBulkBtn();
    }
    function openSupplierModal(i){
      document.getElementById('modal-supplier').classList.remove('hidden');
      document.querySelector('#modal-supplier header .headline').textContent = i!=null? 'Edit Seller/Supplier' : 'Add Seller/Supplier';
      document.getElementById('s-name').value = i!=null? suppliers[i].name : '';
      document.getElementById('s-gst').value = i!=null? suppliers[i].gst : '';
      document.getElementById('s-state').value = i!=null? suppliers[i].state : '';
      document.getElementById('s-addr').value = i!=null? suppliers[i].address : '';
      document.getElementById('s-pin').value = i!=null? suppliers[i].pincode : '';
      document.getElementById('s-logo').value = '';
      document.getElementById('s-logo-preview').style.display='none';
      document.getElementById('s-logo').onchange = ev=>{
        const f = ev.target.files && ev.target.files[0];
        if(!f) return; const ok=['image/jpeg','image/jpg','image/png']; if(!ok.includes(f.type)){ alert('Logo must be JPG/JPEG/PNG'); return; }
        const reader = new FileReader(); reader.onload = ()=>{ document.getElementById('s-logo-preview').src = reader.result; document.getElementById('s-logo-preview').style.display='inline-block'; };
        reader.readAsDataURL(f);
      };
      document.getElementById('modal-supplier').dataset.edit = (i!=null? i : "");
    }
    function closeSupplierModal(){ document.getElementById('modal-supplier').classList.add('hidden'); }
    function saveSupplier(){
      const i = document.getElementById('modal-supplier').dataset.edit;
      const existing = (i!==''? suppliers[i] : {});
      const rec = {
        id: existing.id || uid(),
        name: document.getElementById('s-name').value.trim(),
        gst: document.getElementById('s-gst').value.trim().toUpperCase(),
        state: document.getElementById('s-state').value,
        address: document.getElementById('s-addr').value.trim(),
        pincode: document.getElementById('s-pin').value.trim(),
        logoDataUrl: document.getElementById('s-logo-preview').style.display!=='none'? document.getElementById('s-logo-preview').src : (existing.logoDataUrl || ''),
        signatures: existing.signatures || [],
        defaultSignatureIndex: existing.defaultSignatureIndex || 0,
      };
      const errs = [];
      if(!rec.name) errs.push('Name');
      if(!rec.state) errs.push('State');
      if(!rec.address) errs.push('Address');
      if(!/^\d{6}$/.test(rec.pincode||'')) errs.push('Pincode');
      if(rec.gst && (!/^.{15}$/.test(rec.gst) || !GST_REGEX.test(rec.gst))) errs.push('GST No.');
      if(errs.length){ alert('Please fill required: '+errs.join(', ')); return; }
      if(i!==''){ suppliers[i] = rec; } else { suppliers.push(rec); }
      store.set('suppliers', suppliers);
      closeSupplierModal(); renderSuppliers();
    }
    function deleteSelectedSuppliers(){
      const indices = Array.from(document.querySelectorAll('.supplier-check:checked')).map(cb => +cb.dataset.i);
      suppliers = suppliers.filter((_, idx) => !indices.includes(idx));
      store.set('suppliers', suppliers);
      document.getElementById('suppliers-checkall').checked=false;
      renderSuppliers();
    }

    // Import / templates (suppliers)
    function downloadSupplierTemplate(){
      try{
        const ws = XLSX.utils.aoa_to_sheet([["Name","GST No.","State","Address","Pincode","Logo (optional)"]]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template');
        XLSX.writeFileXLSX(wb, 'Supplier_Import_Template.xlsx');
      }catch(e){ alert('Download failed: '+e.message); }
    }
    async function importSuppliers(file){
      try{
        const data = await file.arrayBuffer(); const wb = XLSX.read(data); const sheet = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(sheet,{defval:""});
        const incoming=[]; rows.forEach(r=>{
          const rec = { id:uid(), name:String(r['Name']).trim(), gst:String(r['GST No.']).trim().toUpperCase(), state:String(r['State']).trim(), address:String(r['Address']).trim(), pincode:String(r['Pincode']).trim(), logoDataUrl:'', signatures:[], defaultSignatureIndex:0 };
          if(!rec.name || !rec.state || !rec.address || !/^\d{6}$/.test(rec.pincode||'')) return;
          if(rec.gst && (!/^.{15}$/.test(rec.gst) || !GST_REGEX.test(rec.gst))) return;
          incoming.push(rec);
        });
        if(!incoming.length){ alert('No valid rows found.'); return; }
        suppliers = suppliers.concat(incoming); store.set('suppliers', suppliers); renderSuppliers();
      }catch(e){ alert('Import failed: '+e.message); }
    }

    // ===== Parties (scoped) =====
    function renderParties() {
        const body = document.getElementById('parties-tbody'); body.innerHTML = '';
        parties.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.name}</td>
                <td>${p.gst || ''}</td>
                <td>${p.state || ''}</td>
                <td>${p.address || ''}</td>
                <td class="right">
                    <button class="btn ghost small" onclick="openPartyModal(${i})">Edit</button>
                    <button class="btn ghost small" style="color:#dc2626;" onclick="deleteParty(${i})">Delete</button>
                </td>`;
            body.appendChild(tr);
        });
    }
    function deleteParty(i){
        if(!confirm(`Are you sure you want to delete party "${parties[i].name}"?`)) return;
        parties.splice(i,1);
        saveScope();
        renderParties();
        refreshPartyDatalist();
    }
    function openPartyModal(i=null){
      document.getElementById('modal-party').classList.remove('hidden');
      document.getElementById('modal-party').dataset.edit = (i!=null? i : "");
      document.getElementById('party-modal-title').textContent = (i!=null)? 'Edit Party' : 'Add Party';

      if(i!=null){
        const p = parties[i];
        document.getElementById('p-name').value = p.name||'';
        document.getElementById('p-pan').value = p.pan||'';
        document.getElementById('p-addr').value = p.address||'';
        document.getElementById('p-gst').value = p.gst||'';
        document.getElementById('p-pin').value = p.pincode||'';
        document.getElementById('p-state').value = p.state||'';
      } else {
        document.getElementById('p-name').value='';
        document.getElementById('p-pan').value='';
        document.getElementById('p-addr').value='';
        document.getElementById('p-gst').value='';
        document.getElementById('p-pin').value='';
        document.getElementById('p-state').value='';
      }
    }
    function openPartyModalForEdit(){
      const name = document.getElementById('bill-party').value;
      if(!name){ alert('Please select a party to edit.'); return; }
      const idx = parties.findIndex(p=> p.name===name);
      if(idx<0){ alert('Selected party not found.'); return; }
      openPartyModal(idx);
    }
    function closePartyModal(){ document.getElementById('modal-party').classList.add('hidden'); }
    function partyGSTChanged(val){
      const up = String(val||'').toUpperCase();
      if(up.length>=12){
        const pan = extractPANFromGST(up);
        const cur = document.getElementById('p-pan').value;
        if(!cur) document.getElementById('p-pan').value = pan;
      }
    }
    function saveParty(){
      const i = document.getElementById('modal-party').dataset.edit;
      const rec = {
        name:document.getElementById('p-name').value.trim(),
        pan:document.getElementById('p-pan').value.trim().toUpperCase(),
        address:document.getElementById('p-addr').value.trim(),
        gst:document.getElementById('p-gst').value.trim().toUpperCase(),
        pincode:document.getElementById('p-pin').value.trim(),
        state:document.getElementById('p-state').value
      };
      const errs=[];
      if(!rec.name) errs.push('Party name');
      if(!rec.address) errs.push('Party Address');
      if(!/^\d{6}$/.test(rec.pincode||'')) errs.push('Pincode');
      if(!rec.state) errs.push('State');
      if(rec.gst && (!/^.{15}$/.test(rec.gst) || !GST_REGEX.test(rec.gst))) errs.push('Party GST No.');
      if(errs.length){ alert('Please fill required: '+errs.join(', ')); return; }
      if(rec.gst && !rec.pan) rec.pan = extractPANFromGST(rec.gst);

      if(i!==''){ parties[i] = rec; } else { parties.push(rec); }
      saveScope();
      closePartyModal();
      refreshPartyDatalist();
      renderParties();
      if(invoice && invoice.billedTo && invoice.billedTo.name === rec.name){
        selectBilledParty(rec.name);
      }
    }
    function downloadPartyTemplate(){
        try{
            const ws = XLSX.utils.aoa_to_sheet([["Party name","State","Party Address","Party GST No.","Party PAN","Pincode"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFileXLSX(wb, 'Party_Import_Template.xlsx');
        } catch(e) { alert('Download failed: '+e.message); }
    }
    async function importParties(file){
      try{
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data);
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet,{defval:""});
        const incoming=[];
        rows.forEach(r=>{
          const rec = {
            name:String(r['Party name']).trim(),
            state:String(r['State']).trim(),
            address:String(r['Party Address']).trim(),
            gst:String(r['Party GST No.']).trim().toUpperCase(),
            pan:String(r['Party PAN']).trim().toUpperCase(),
            pincode:String(r['Pincode']).trim()
          };
          if(!rec.name || !rec.address || !/^\d{6}$/.test(rec.pincode||'') || !rec.state) return;
          if(rec.gst && (!/^.{15}$/.test(rec.gst) || !GST_REGEX.test(rec.gst))) return;
          if(rec.gst && !rec.pan) rec.pan = extractPANFromGST(rec.gst);
          incoming.push(rec);
        });
        if(!incoming.length){ alert('No valid rows found.'); return; }
        parties = parties.concat(incoming); saveScope(); refreshPartyDatalist(); renderParties();
      }catch(e){ alert('Import failed: '+e.message); }
    }
    function refreshPartyDatalist(){
      const list = document.getElementById('party-list');
      list.innerHTML = parties.map(p => `<option value="${p.name}"></option>`).join('');
    }

    // ===== Invoice Page =====
    function enterInvoice(i){
      currentSupplierIndex = i;
      const sup = suppliers[currentSupplierIndex];
      scopeKey = sup.id;
      loadScope();
      invoice = null;
      editingInvoiceNo = null;
      routeTo('invoice');
    }
    function renderInvoicePage(){
      const s = suppliers[currentSupplierIndex] || {name:'Your Company', address:'', gst:'', state:'', logoDataUrl:''};
      // Supplier header on invoice page
      document.getElementById('current-supplier-name').textContent = s.name;
      document.getElementById('current-supplier-gst').textContent = s.gst ? `(GSTIN: ${s.gst})` : '';
      document.getElementById('current-supplier-address').textContent = s.address;
      const supDashBtn = document.getElementById('btn-supplier-dash');
      supDashBtn.textContent = `${(s.name || 'Supplier').split(' ')[0]} Dashboard`;
      
      document.getElementById('sup-name').textContent = s.name || 'Your Company';
      document.getElementById('sup-addr').textContent = s.address || '';
      document.getElementById('sup-gst').textContent = s.gst? ('GSTIN : '+s.gst) : 'GSTIN : NA';
      document.getElementById('p-supname2').textContent = s.name || 'Your Company';
      const logo = document.getElementById('sup-logo');
      if(s.logoDataUrl){ logo.src=s.logoDataUrl; logo.style.display='inline-block'; } else { logo.style.display='none'; }

      document.getElementById('btn-save-edit').classList.toggle('hidden', !editingInvoiceNo);
      document.getElementById('btn-generate').classList.toggle('hidden', !!editingInvoiceNo);
      document.getElementById('inv-no').disabled = !!editingInvoiceNo;

      if(!invoice){
        invoice = freshInvoiceObject();
      }
      document.getElementById('inv-no').value = invoice.invoiceNo;
      document.getElementById('inv-date').value = invoice.dated;

      refreshPartyDatalist();
      updateDatalists();
      document.getElementById('bill-party').value = invoice.billedTo.name || '';
      document.getElementById('bill-address').value = invoice.billedTo.address || '';
      document.getElementById('bill-gst').value = invoice.billedTo.gst || '';
      document.getElementById('bill-pan').value = invoice.billedTo.pan || '';
      document.getElementById('bill-pin').value = invoice.billedTo.pincode || '';
      document.getElementById('bill-state').value = invoice.billedTo.state || '';

      const shipEnabled = !!(invoice.shippedTo && (invoice.shippedTo.name || invoice.shippedTo.address || invoice.shippedTo.gst || invoice.shippedTo.pan || invoice.shippedTo.pincode || invoice.shippedTo.state));
      document.getElementById('ship-enable').checked = shipEnabled;
      toggleShip();
      if(shipEnabled){
        document.getElementById('ship-name').value = invoice.shippedTo.name || '';
        document.getElementById('ship-address').value = invoice.shippedTo.address || '';
        document.getElementById('ship-gst').value = invoice.shippedTo.gst || '';
        document.getElementById('ship-pan').value = invoice.shippedTo.pan || '';
        document.getElementById('ship-pin').value = invoice.shippedTo.pincode || '';
        document.getElementById('ship-state').value = invoice.shippedTo.state || '';
      }

      renderItems();
      recalcTotals();
    }
    function freshInvoiceObject(){
      return {
        invoiceNo: `INV-${pad2(invSeq)}`,
        dated: new Date().toISOString().slice(0,10),
        reverseCharge:'', grrrNo:'', transport:'', vehicleNo:'', station:'', eway:'',
        billedTo:{ name:'', address:'', gst:'', pan:'', pincode:'', state:'' },
        shippedTo:{ name:'', address:'', gst:'', pan:'', pincode:'', state:'' },
        items:[ { desc:'', hsn:'', taxRate:5, qty:1, unit:'Kgs.', listPrice:0, discount:0 } ],
        terms: document.getElementById('inv-terms').value
      };
    }

    function selectBilledParty(name){
      const p = parties.find(x=> x.name===name);
      if(!p) return;
      invoice.billedTo = { name:p.name, address:p.address, gst:p.gst, pan:p.pan, pincode:p.pincode, state:p.state };
      document.getElementById('bill-address').value = p.address || '';
      document.getElementById('bill-gst').value = p.gst || '';
      document.getElementById('bill-pan').value = p.pan || '';
      document.getElementById('bill-pin').value = p.pincode || '';
      document.getElementById('bill-state').value = p.state || '';
      recalcTotals();
    }
    function toggleShip(){
      const en = document.getElementById('ship-enable').checked;
      ['ship-name','ship-address','ship-gst','ship-pan','ship-pin','ship-state'].forEach(id=>{
        const el = document.getElementById(id); el.disabled = !en; if(!en) el.value='';
      });
      if(!en){
        invoice.shippedTo = { name:'', address:'', gst:'', pan:'', pincode:'', state:'' };
      } else {
        invoice.shippedTo = {
          name: document.getElementById('ship-name').value || '',
          address: document.getElementById('ship-address').value || '',
          gst: document.getElementById('ship-gst').value || '',
          pan: document.getElementById('ship-pan').value || '',
          pincode: document.getElementById('ship-pin').value || '',
          state: document.getElementById('ship-state').value || '',
        };
      }
    }

    function addItemRow(){
      invoice.items.push({ desc:'', hsn:'', taxRate:5, qty:1, unit:'Kgs.', listPrice:0, discount:0 });
      renderItems(); recalcTotals();
      setTimeout(()=>{ document.getElementById('sum-amount').scrollIntoView({behavior:'smooth', block:'center'}); }, 0);
    }
    function deleteItemRow(i){ invoice.items.splice(i,1); renderItems(); recalcTotals(); }

    function renderItems(){
      const body = document.getElementById('items-tbody'); body.innerHTML='';
      invoice.items.forEach((r,i)=>{
        const price = Number(r.listPrice) * (1 - Number(r.discount||0)/100);
        const amount = Number(r.qty) * price;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}.</td>
          <td><input class="input" value="${r.desc}" data-f="desc" data-i="${i}" list="desc-list"></td>
          <td><input class="input" value="${r.hsn}" data-f="hsn" data-i="${i}" list="hsn-list"></td>
          <td><input class="input" type="number" step="0.01" value="${r.taxRate}" data-f="taxRate" data-i="${i}" list="tax-rate-list"></td>
          <td><input class="input" type="number" step="0.01" value="${r.qty}" data-f="qty" data-i="${i}"></td>
          <td><input class="input" value="${r.unit}" data-f="unit" data-i="${i}" list="unit-list"></td>
          <td><input class="input" type="number" step="0.01" value="${r.listPrice}" data-f="listPrice" data-i="${i}"></td>
          <td><input class="input" type="number" step="0.01" value="${r.discount}" data-f="discount" data-i="${i}"></td>
          <td class="right" data-calc="price" data-i="${i}">₹ ${currency(price)}</td>
          <td class="right" data-calc="amount" data-i="${i}">₹ ${currency(amount)}</td>
          <td class="right"><button class="btn ghost small" style="color:#dc2626;" data-del="${i}">Delete</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('input[data-f]').forEach(inp=> inp.addEventListener('input', onItemChange));
      body.querySelectorAll('button[data-del]').forEach(btn=> btn.addEventListener('click', ()=> deleteItemRow(+btn.dataset.del)));
    }
    function onItemChange(e){
      const i = +e.target.dataset.i; const f = e.target.dataset.f; let v = e.target.value;
      if(['taxRate','qty','listPrice','discount'].includes(f)) v = Number(v||0);
      invoice.items[i][f] = v;
      const r = invoice.items[i];
      const price = Number(r.listPrice) * (1 - Number(r.discount||0)/100);
      const amount = Number(r.qty) * price;
      const priceCell = document.querySelector(`td[data-calc="price"][data-i="${i}"]`);
      const amountCell = document.querySelector(`td[data-calc="amount"][data-i="${i}"]`);
      if(priceCell) priceCell.textContent = '₹ ' + currency(price);
      if(amountCell) amountCell.textContent = '₹ ' + currency(amount);
      recalcTotals();
    }

    function sameStateSupply(){
      const sup = suppliers[currentSupplierIndex] || {};
      const party = invoice?.billedTo || {};
      if(!sup.state || !party.state) return false; // treat as inter-state unless both states explicitly match
      return (String(sup.state).trim().toLowerCase() === String(party.state).trim().toLowerCase());
    }

    function groupByHSNAndRate(items){
      const map = new Map();
      items.forEach(r=>{
        if(!String(r.desc||'').trim()) return;
        const key = `${r.hsn||''}__${Number(r.taxRate||0)}`;
        const qty = Number(r.qty)||0;
        const price = Number(r.listPrice||0) * (1 - Number(r.discount||0)/100);
        const taxable = qty*price;
        if(!map.has(key)){
          map.set(key, { hsn:r.hsn||'', rate:Number(r.taxRate||0), taxable:0 });
        }
        map.get(key).taxable += taxable;
      });
      return Array.from(map.values());
    }

    function recalcTotals(){
      const same = sameStateSupply();
      let taxable=0, cgst=0, sgst=0, igst=0, qtyTotal=0, amountTotal=0;

      invoice.items.forEach(r=>{
        if(!String(r.desc||'').trim()) return;
        const price = Number(r.listPrice)*(1-Number(r.discount||0)/100);
        const amount = Number(r.qty)*price;
        const t = amount*(Number(r.taxRate||0)/100);
        qtyTotal += Number(r.qty)||0;
        amountTotal += amount;
        taxable += amount;
        if(same){ cgst += t/2; sgst += t/2; } else { igst += t; }
      });
      const grand = taxable + cgst + sgst + igst;

      // Totals (screen)
      document.getElementById('tot-taxable').textContent = '₹ '+currency(taxable);
      document.getElementById('tot-cgst').textContent = '₹ '+currency(cgst);
      document.getElementById('tot-sgst').textContent = '₹ '+currency(sgst);
      document.getElementById('tot-igst').textContent = '₹ '+currency(igst);
      document.getElementById('tot-grand').textContent = '₹ '+currency(grand);

      // Footer sums
      document.getElementById('sum-qty').textContent = qtyTotal;
      document.getElementById('sum-amount').textContent = '₹ '+currency(amountTotal);

      // Printable items table
      const pItems = document.getElementById('p-items'); pItems.innerHTML='';
      invoice.items.forEach((r,i)=>{
        if(!String(r.desc||'').trim()) return;
        const price = Number(r.listPrice)*(1-Number(r.discount||0)/100);
        const amount = Number(r.qty)*price;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class='center'>${i+1}.</td><td>${r.desc}</td><td class='center'>${r.hsn||''}</td><td class='center'>${Number(r.taxRate||0).toFixed(2)} %</td><td class='center'>${r.qty}</td><td class='center'>${r.unit}</td><td class='center'>${currency(r.listPrice)}</td><td class='center'>${Number(r.discount||0).toFixed(2)} %</td><td class='center'>${currency(price)}</td><td class='right'>${currency(amount)}</td>`;
        pItems.appendChild(tr);
      });

      // Printable totals
      document.getElementById('p-taxable').textContent = '₹ '+currency(taxable);
      document.getElementById('p-cgst').textContent = '₹ '+currency(cgst);
      document.getElementById('p-sgst').textContent = '₹ '+currency(sgst);
      document.getElementById('p-igst').textContent = '₹ '+currency(igst);
      document.getElementById('p-grand').textContent = '₹ '+currency(grand);
      document.getElementById('p-words').textContent = toWords(grand);

      // HSN Summary (screen + print)
      const groups = groupByHSNAndRate(invoice.items);
      const tbody = document.getElementById('hsn-summary-body'); tbody.innerHTML='';
      const pSum = document.getElementById('p-hsn-summary'); pSum.innerHTML='';
      groups.forEach(g=>{
        const tax = g.taxable * (g.rate/100);
        const _cgst = same? (tax/2) : 0;
        const _sgst = same? (tax/2) : 0;
        const tr1 = document.createElement('tr');
        tr1.innerHTML = `<td>${g.hsn||''}</td><td>${g.rate.toFixed(2)}</td><td class="right">${currency(g.taxable)}</td><td class="right">${currency(_cgst)}</td><td class="right">${currency(_sgst)}</td><td class="right">${currency(tax)}</td>`;
        tbody.appendChild(tr1);
        const tr2 = tr1.cloneNode(true);
        pSum.appendChild(tr2);
      });
    }

    // ===== More Details =====
    function openMoreDetails(){
      document.getElementById('modal-more').classList.remove('hidden');
      document.getElementById('m-rc').value=invoice.reverseCharge||'';
      document.getElementById('m-gr').value=invoice.grrrNo||'';
      document.getElementById('m-transport').value=invoice.transport||'';
      document.getElementById('m-veh').value=invoice.vehicleNo||'';
      document.getElementById('m-station').value=invoice.station||'';
      document.getElementById('m-eway').value=invoice.eway||'';
    }
    function closeMoreDetails(){ document.getElementById('modal-more').classList.add('hidden'); }
    function applyMoreDetails(){
      invoice.reverseCharge=document.getElementById('m-rc').value;
      invoice.grrrNo=document.getElementById('m-gr').value;
      invoice.transport=document.getElementById('m-transport').value;
      invoice.vehicleNo=document.getElementById('m-veh').value;
      invoice.station=document.getElementById('m-station').value;
      invoice.eway=document.getElementById('m-eway').value;
      closeMoreDetails(); syncPrintableHeader();
    }
    function syncPrintableHeader(){
      document.getElementById('p-invno').textContent = document.getElementById('inv-no').value = (invoice.invoiceNo||'');
      document.getElementById('p-date').textContent = document.getElementById('inv-date').value = (invoice.dated||'');
      document.getElementById('p-rc').textContent = na(invoice.reverseCharge);
      document.getElementById('p-gr').textContent = na(invoice.grrrNo);
      document.getElementById('p-transport').textContent = na(invoice.transport);
      document.getElementById('p-veh').textContent = na(invoice.vehicleNo);
      document.getElementById('p-station').textContent = na(invoice.station);
      document.getElementById('p-eway').textContent = na(invoice.eway);

      const b = invoice.billedTo||{};
      document.getElementById('p-bill').textContent = `${na(b.name)}
${na(b.address)}
GSTIN / UIN : ${na(b.gst)}
PAN : ${na(b.pan)}
Pincode : ${na(b.pincode)}
State : ${na(b.state)}`;

      const shipEnabled = document.getElementById('ship-enable').checked;
      const s = invoice.shippedTo||{};
      const shipText = shipEnabled
        ? `${na(s.name)}
${na(s.address)}
GSTIN / UIN : ${na(s.gst)}
PAN : ${na(s.pan)}
Pincode : ${na(s.pincode)}
State : ${na(s.state)}`
        : 'NA';
      document.getElementById('p-ship').textContent = shipText;
      document.getElementById('p-terms').textContent = invoice.terms || '';
    }

    // ===== Items import/template =====
    function downloadItemsTemplate(){
      try{
        const ws = XLSX.utils.aoa_to_sheet([["Description of Goods","HSN/SAC Code","Tax Rate","Qty.","Unit","List Price","Discount"]]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template');
        XLSX.writeFileXLSX(wb, 'Invoice_Items_Import_Template.xlsx');
      }catch(e){ alert('Download failed: '+e.message); }
    }
    async function importItems(file){
      try{
        const data = await file.arrayBuffer(); const wb = XLSX.read(data); const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet,{defval:""});
        const incoming=[]; rows.forEach(r=>{
          const rec = {
            desc:String(r['Description of Goods']).trim(),
            hsn:String(r['HSN/SAC Code']).trim(),
            taxRate:Number(r['Tax Rate'])||0,
            qty:Number(r['Qty.'])||0,
            unit:String(r['Unit']).trim()||'Kgs.',
            listPrice:Number(r['List Price'])||0,
            discount:Number(r['Discount'])||0
          };
          if(!rec.desc) return; incoming.push(rec);
        });
        if(!incoming.length){ alert('No valid rows found.'); return; }
        invoice.items = invoice.items.concat(incoming);
        learnFromItems(invoice.items);
        saveScope();
        updateDatalists();
        renderItems(); recalcTotals();
      }catch(e){ alert('Import failed: '+e.message); }
    }

    // ===== Reports (scoped) =====
    function clearReportFilters() {
        document.getElementById('report-from').value = '';
        document.getElementById('report-to').value = '';
        document.getElementById('report-search').value = '';
        renderReports();
    }
    function fitsReportFilters(r){
      const f = document.getElementById('report-from').value;
      const t = document.getElementById('report-to').value;
      const q = (document.getElementById('report-search').value || '').trim().toLowerCase();

      if(q && !String(r.billedParty||'').toLowerCase().includes(q)) return false;
      if(f && (!r.dated || r.dated < f)) return false;
      if(t && (!r.dated || r.dated > t)) return false;
      return true;
    }
    function renderReports(){
      const tbody = document.getElementById('reports-tbody'); tbody.innerHTML='';
      const rows = reports.filter(fitsReportFilters);

      rows.forEach((r)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="center"><input type="checkbox" class="report-check" data-inv="${r.invoiceNo}" ${r.selected?'checked':''} /></td>
          <td>${r.invoiceNo}</td>
          <td>${r.billedParty}</td>
          <td>${r.gstRate}</td>
          <td>${r.hsn}</td>
          <td>${currency(r.taxable)}</td>
          <td>${currency(r.tax)}</td>
          <td>${formatDate(r.dated)}</td>
          <td class='right nowrap'>
            <button class='btn ghost small' onclick="downloadInvoicePDF('${r.invoiceNo}')">PDF</button>
            <button class='btn ghost small' onclick="downloadInvoiceExcel('${r.invoiceNo}')">Excel</button>
            <button class='btn ghost small' onclick="editInvoice('${r.invoiceNo}')">Edit</button>
            <button class='btn ghost small' style='color:#dc2626;' onclick="deleteReport('${r.invoiceNo}')">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.report-check').forEach(ch=>{
        ch.addEventListener('change', (e)=>{
          const invNo = e.target.dataset.inv;
          const idx = reports.findIndex(x=> x.invoiceNo===invNo);
          if(idx>-1){ reports[idx].selected = e.target.checked; saveScope(); }
          updateZipBtnState();
        });
      });
      const allInView = rows.length && rows.every(r=> r.selected);
      document.getElementById('reports-checkall').checked = !!allInView;
      updateZipBtnState();
    }
    function updateZipBtnState(){
      const rows = reports.filter(fitsReportFilters);
      const any = rows.some(r=> r.selected);
      document.getElementById('btn-zip').disabled = !any;
    }
    function toggleSelectAllReports(hdr){
      const rows = reports.filter(fitsReportFilters);
      rows.forEach(r=> r.selected = hdr.checked);
      saveScope();
      renderReports();
    }
    function deleteReport(invNo){
      if(!confirm(`Are you sure you want to delete invoice ${invNo}? This cannot be undone.`)) return;
      const i = reports.findIndex(r=> r.invoiceNo===invNo);
      if(i>-1){ reports.splice(i,1); }
      const j = invoices.findIndex(inv=> inv.invoiceNo===invNo);
      if(j>-1){ invoices.splice(j,1); }
      saveScope();
      renderReports();
    }
    function downloadReportsExcel(){
      try{
        const ws = XLSX.utils.json_to_sheet(reports);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Reports');
        XLSX.writeFileXLSX(wb, 'Invoice_Reports.xlsx');
      }catch(e){ alert('Download failed: '+e.message); }
    }

    // ===== Data Learning from Items =====
    function learnFromItems(items) {
        const unique = (arr) => [...new Set(arr.filter(Boolean))];
        items.forEach(item => {
            if (item.desc) descriptions.push(item.desc);
            if (item.hsn) hsns.push(item.hsn);
            if (item.taxRate) taxRates.push(Number(item.taxRate));
            if (item.unit) units.push(item.unit);
        });
        descriptions = unique(descriptions);
        hsns = unique(hsns);
        taxRates = unique(taxRates).sort((a, b) => a - b);
        units = unique(units);
    }

    // ===== Generate + Save (direct PDF) =====
    function validateBeforeGenerate(){
      invoice.invoiceNo = document.getElementById('inv-no').value.trim();
      invoice.dated = document.getElementById('inv-date').value.trim();
      invoice.terms = document.getElementById('inv-terms').value;
      const errs=[];
      if(!invoice.invoiceNo) errs.push('Invoice Number');
      if(!invoice.dated) errs.push('Dated');
      if(!invoice.billedTo.name) errs.push('Party name');
      if(!invoice.billedTo.address) errs.push('Party Address');
      if(!invoice.billedTo.pincode) errs.push('Pincode');
      if(!invoice.billedTo.state) errs.push('Party State');
      const hasItem = invoice.items && invoice.items.some(r=> String(r.desc||'').trim() && Number(r.qty||0)>0);
      if(!hasItem) errs.push('At least 1 item');
      if(errs.length){ alert('Please fill required: '+errs.join(', ')); return false; }

      // Duplicate invoice check
      if (invoices.some(inv => inv.invoiceNo === invoice.invoiceNo)) {
          alert(`Invoice number "${invoice.invoiceNo}" already exists. Please use a unique invoice number.`);
          return false;
      }
      return true;
    }
    function summarizeForReports(inv){
      const map = new Map();
      (inv.items||[]).forEach(r=>{
        if(!String(r.desc||'').trim()) return;
        const key = `${r.hsn||''}__${Number(r.taxRate||0)}`;
        const price = Number(r.listPrice||0) * (1 - Number(r.discount||0)/100);
        const taxable = Number(r.qty||0)*price;
        if(!map.has(key)) map.set(key, {hsn:r.hsn||'', rate:Number(r.taxRate||0), taxable:0});
        map.get(key).taxable += taxable;
      });
      const groups = Array.from(map.values());
      const allRates = Array.from(new Set(groups.map(g=> g.rate)));
      const allHSN = Array.from(new Set(groups.map(g=> g.hsn||'')));
      let taxable=0, tax=0;
      groups.forEach(g=>{ taxable += g.taxable; tax += g.taxable * (g.rate/100); });
      return {
        invoiceNo: inv.invoiceNo,
        billedParty: inv.billedTo.name,
        gstRate: allRates.length===1? allRates[0] : 'Mixed',
        hsn: allHSN.length===1? (allHSN[0]||'') : 'Mixed',
        taxable, tax, dated: inv.dated, selected:false
      };
    }
    async function generateInvoice(){
      if(!validateBeforeGenerate()) return;

      const sup = suppliers[currentSupplierIndex] || {};
      const snapshot = JSON.parse(JSON.stringify(invoice));
      snapshot.supplier = { name:sup.name||'', address:sup.address||'', gst:sup.gst||'', state:sup.state||'', logoDataUrl:sup.logoDataUrl||'', signatures: sup.signatures || [], defaultSignatureIndex: sup.defaultSignatureIndex || 0 };

      invoices.push(snapshot);
      reports.push(summarizeForReports(snapshot));
      learnFromItems(snapshot.items);
      saveScope();

      // prepare printable & download PDF (NO print dialog)
      fillPrintAreaFromSnapshot(snapshot);
      await new Promise(r=> setTimeout(r, 20));
      const blob = await makePdfBlobFromCurrentPrintArea();
      triggerBlobDownload(blob, snapshot.invoiceNo+'.pdf');

      // increment sequence and reset to fresh invoice
      invSeq += 1;
      saveScope();
      invoice = freshInvoiceObject();
      editingInvoiceNo = null;
      renderInvoicePage();
    }

    // ===== Edit existing invoice =====
    function editInvoice(invNo){
      const snap = invoices.find(x=> x.invoiceNo===invNo);
      if(!snap){ alert('Saved invoice not found for '+invNo); return; }
      editingInvoiceNo = invNo;
      invoice = JSON.parse(JSON.stringify(snap));
      routeTo('invoice');
      setTimeout(()=>{ syncPrintableHeader(); recalcTotals(); }, 0);
    }
    function saveEditedInvoice(){
      if(!invoice){ return; }
      const errs=[];
      if(!invoice.invoiceNo) errs.push('Invoice Number');
      if(!invoice.billedTo || !invoice.billedTo.name) errs.push('Party name');
      if(!invoice.billedTo || !invoice.billedTo.address) errs.push('Party Address');
      if(!invoice.billedTo || !invoice.billedTo.pincode) errs.push('Pincode');
      if(!invoice.billedTo || !invoice.billedTo.state) errs.push('Party State');
      const hasItem = invoice.items && invoice.items.some(r=> String(r.desc||'').trim() && Number(r.qty||0)>0);
      if(!hasItem) errs.push('At least 1 item');
      if(errs.length){ alert('Please fill required: '+errs.join(', ')); return; }

      const sup = suppliers[currentSupplierIndex] || {};
      const snapshot = JSON.parse(JSON.stringify(invoice));
      snapshot.supplier = { name:sup.name||'', address:sup.address||'', gst:sup.gst||'', state:sup.state||'', logoDataUrl:sup.logoDataUrl||'', signatures: sup.signatures || [], defaultSignatureIndex: sup.defaultSignatureIndex || 0 };

      invoices = invoices.filter(x=> x.invoiceNo!==editingInvoiceNo);
      invoices.push(snapshot);
      reports = reports.filter(r=> r.invoiceNo!==editingInvoiceNo);
      reports.push(summarizeForReports(snapshot));
      learnFromItems(snapshot.items);
      saveScope();

      editingInvoiceNo = null;
      invoice = freshInvoiceObject();
      renderInvoicePage();
      alert('Invoice changes saved.');
    }

    // ===== PDF / Excel =====
    function fillPrintAreaFromSnapshot(inv){
      const sup = inv.supplier || {};
      document.getElementById('sup-name').textContent = sup.name || 'Your Company';
      document.getElementById('sup-addr').textContent = na(sup.address);
      document.getElementById('sup-gst').textContent = sup.gst ? ('GSTIN : '+sup.gst) : 'GSTIN : NA';
      document.getElementById('p-supname2').textContent = sup.name || 'Your Company';
      const logo = document.getElementById('sup-logo');
      if(sup.logoDataUrl){ logo.src=sup.logoDataUrl; logo.style.display='inline-block'; } else { logo.style.display='none'; }
      
      const sigImg = document.getElementById('p-signature');
      const sigIndex = sup.defaultSignatureIndex || 0;
      if(sup.signatures && sup.signatures[sigIndex]){
        sigImg.src = sup.signatures[sigIndex];
        sigImg.style.display = 'block';
      } else {
        sigImg.style.display = 'none';
      }

      document.getElementById('p-invno').textContent = inv.invoiceNo || '';
      document.getElementById('p-date').textContent = formatDate(inv.dated) || '';
      document.getElementById('p-rc').textContent = na(inv.reverseCharge);
      document.getElementById('p-gr').textContent = na(inv.grrrNo);
      document.getElementById('p-transport').textContent = na(inv.transport);
      document.getElementById('p-veh').textContent = na(inv.vehicleNo);
      document.getElementById('p-station').textContent = na(inv.station);
      document.getElementById('p-eway').textContent = na(inv.eway);

      const b = inv.billedTo||{};
      document.getElementById('p-bill').textContent = `${na(b.name)}
${na(b.address)}
GSTIN / UIN : ${na(b.gst)}
PAN : ${na(b.pan)}
Pincode : ${na(b.pincode)}
State : ${na(b.state)}`;
      const s = inv.shippedTo||{};
      const shipText = (s.name||s.address||s.gst||s.pan||s.pincode||s.state)
        ? `${na(s.name)}
${na(s.address)}
GSTIN / UIN : ${na(s.gst)}
PAN : ${na(s.pan)}
Pincode : ${na(s.pincode)}
State : ${na(s.state)}`
        : 'NA';
      document.getElementById('p-ship').textContent = shipText;

      const pItems = document.getElementById('p-items'); pItems.innerHTML='';
      (inv.items||[]).forEach((r,i)=>{
        if(!String(r.desc||'').trim()) return;
        const price = Number(r.listPrice)*(1-Number(r.discount||0)/100);
        const amount = Number(r.qty)*price;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class='center'>${i+1}.</td><td>${r.desc}</td><td class='center'>${r.hsn||''}</td><td class='center'>${Number(r.taxRate||0).toFixed(2)} %</td><td class='center'>${r.qty}</td><td class='center'>${r.unit}</td><td class='center'>${currency(r.listPrice)}</td><td class='center'>${Number(r.discount||0).toFixed(2)} %</td><td class='center'>${currency(price)}</td><td class='right'>${currency(amount)}</td>`;
        pItems.appendChild(tr);
      });

      const same = (inv.supplier?.state && inv.billedTo?.state) ? (String(inv.supplier.state).trim().toLowerCase() === String(inv.billedTo.state).trim().toLowerCase()) : false;
      let taxable=0, cgst=0, sgst=0, igst=0;
      (inv.items||[]).forEach(r=>{
        if(!String(r.desc||'').trim()) return;
        const price = Number(r.listPrice)*(1-Number(r.discount||0)/100);
        const amount = Number(r.qty)*price;
        const t = amount*(Number(r.taxRate||0)/100);
        taxable += amount;
        if(same){ cgst += t/2; sgst += t/2; } else { igst += t; }
      });
      const grand = taxable + cgst + sgst + igst;
      document.getElementById('p-taxable').textContent = '₹ '+currency(taxable);
      document.getElementById('p-cgst').textContent = '₹ '+currency(cgst);
      document.getElementById('p-sgst').textContent = '₹ '+currency(sgst);
      document.getElementById('p-igst').textContent = '₹ '+currency(igst);
      document.getElementById('p-grand').textContent = '₹ '+currency(grand);
      document.getElementById('p-words').textContent = toWords(grand);

      // HSN summary (print)
      const pSum = document.getElementById('p-hsn-summary'); pSum.innerHTML='';
      const groups = groupByHSNAndRate(inv.items||[]);
      groups.forEach(g=>{
        const tax = g.taxable * (g.rate/100);
        const _cgst = same? (tax/2) : 0;
        const _sgst = same? (tax/2) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${g.hsn||''}</td><td>${g.rate.toFixed(2)}</td><td class="right">${currency(g.taxable)}</td><td class="right">${currency(_cgst)}</td><td class="right">${currency(_sgst)}</td><td class="right">${currency(tax)}</td>`;
        pSum.appendChild(tr);
      });
    }

    async function makePdfBlobFromCurrentPrintArea(){
      const { jsPDF } = window.jspdf;
      const node = document.getElementById('printArea');
      const canvas = await html2canvas(node, { scale: 2, useCORS: true });
      const img = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p','pt','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth;
      const imgHeight = canvas.height * imgWidth / canvas.width;

      let position = 0;
      let heightLeft = imgHeight;

      pdf.addImage(img, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while(heightLeft > 0){
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(img, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }
      return pdf.output('blob');
    }

    async function downloadInvoicePDF(invNo){
      const inv = invoices.find(x=> x.invoiceNo===invNo);
      if(!inv){ alert('Saved invoice not found for '+invNo); return; }
      fillPrintAreaFromSnapshot(inv);
      await new Promise(r=> setTimeout(r, 20));
      const blob = await makePdfBlobFromCurrentPrintArea();
      triggerBlobDownload(blob, invNo+'.pdf');
    }

    // Excel export (single invoice)
    function buildInvoiceExcel(inv){
      const wb = XLSX.utils.book_new();

      const sup = inv.supplier || {};
      const b = inv.billedTo || {};
      const s = inv.shippedTo || {};
      const header = [
        ["Supplier Name", sup.name||""],
        ["Supplier GST", sup.gst||""],
        ["Supplier Address", sup.address||""],
        ["Supplier State", sup.state||""],
        [],
        ["Invoice No.", inv.invoiceNo||"", "Date", inv.dated||""],
        ["Reverse Charge", inv.reverseCharge||"", "GR/RR No.", inv.grrrNo||""],
        ["Transport", inv.transport||"", "Vehicle No.", inv.vehicleNo||""],
        ["Station", inv.station||"", "E-Way Bill No.", inv.eway||""],
        [],
        ["Billed To - Name", b.name||"", "GSTIN", b.gst||""],
        ["Billed To - Address", b.address||""],
        ["Billed To - PAN", b.pan||"", "Pincode", b.pincode||"", "State", b.state||""],
        [],
        ["Shipped To - Name", s.name||"", "GSTIN", s.gst||""],
        ["Shipped To - Address", s.address||""],
        ["Shipped To - PAN", s.pan||"", "Pincode", s.pincode||"", "State", s.state||""]
      ];
      const wsHeader = XLSX.utils.aoa_to_sheet(header);
      XLSX.utils.book_append_sheet(wb, wsHeader, 'Invoice');

      const items = (inv.items||[]).filter(r=> String(r.desc||'').trim()).map(r=>{
        const price = Number(r.listPrice||0)*(1-Number(r.discount||0)/100);
        const amount = Number(r.qty||0)*price;
        return {
          "Description of Goods": r.desc,
          "HSN/SAC Code": r.hsn||'',
          "Tax Rate (%)": Number(r.taxRate||0),
          "Qty.": Number(r.qty||0),
          "Unit": r.unit||'',
          "List Price": Number(r.listPrice||0),
          "Discount": Number(r.discount||0),
          "Price": price,
          "Amount": amount
        };
      });
      const wsItems = XLSX.utils.json_to_sheet(items);
      XLSX.utils.book_append_sheet(wb, wsItems, 'Items');

      return wb;
    }
    function downloadInvoiceExcel(invNo){
      const inv = invoices.find(x=> x.invoiceNo===invNo);
      if(!inv){ alert('Saved invoice not found for '+invNo); return; }
      const wb = buildInvoiceExcel(inv);
      XLSX.writeFileXLSX(wb, `${invNo}.xlsx`);
    }
    function downloadCurrentInvoiceExcel(){
      const sup = suppliers[currentSupplierIndex] || {};
      const snapshot = JSON.parse(JSON.stringify(invoice));
      snapshot.supplier = { name:sup.name||'', address:sup.address||'', gst:sup.gst||'', state:sup.state||'', logoDataUrl:sup.logoDataUrl||'' };
      const wb = buildInvoiceExcel(snapshot);
      XLSX.writeFileXLSX(wb, `${snapshot.invoiceNo||'Invoice'}.xlsx`);
    }

    // ===== ZIP bulk download from Reports =====
    async function downloadSelectedZip(){
      const selected = reports.filter(r=> fitsReportFilters(r) && r.selected).map(r=> r.invoiceNo);
      if(!selected.length){ alert('No invoices selected.'); return; }
      const btn = document.getElementById('btn-zip');
      const originalText = btn.textContent;
      btn.textContent = 'Preparing... 0%';
      btn.disabled = true;

      try {
        const zip = new JSZip();
        for(let i=0; i<selected.length; i++){
          const invNo = selected[i];
          btn.textContent = `Preparing... ${Math.round((i/selected.length)*100)}%`;
          const inv = invoices.find(x=> x.invoiceNo===invNo);
          if(!inv) continue;
          fillPrintAreaFromSnapshot(inv);
          await new Promise(r=> setTimeout(r, 50)); // a slightly longer delay for rendering stability
          const blob = await makePdfBlobFromCurrentPrintArea();
          zip.file(invNo+'.pdf', blob);
        }
        btn.textContent = 'Zipping...';
        const content = await zip.generateAsync({type:'blob'});
        const stamp = new Date().toISOString().slice(0,10);
        triggerBlobDownload(content, `Invoices_${stamp}.zip`);
      } catch (e) {
          alert('An error occurred while creating the ZIP file: ' + e.message);
      } finally {
          btn.textContent = originalText;
          btn.disabled = false;
      }
    }

    // ===== Supplier Dashboard =====
    function renderSupplierDashboard(){
        const sup = suppliers[currentSupplierIndex];
        if(!sup) return;
        const container = document.getElementById('s-signatures-container');
        const select = document.getElementById('s-signature-default');
        container.innerHTML = '';
        select.innerHTML = '<option value="-1">No Default Signature</option>';

        (sup.signatures || []).forEach((sigDataUrl, i) => {
            const div = document.createElement('div');
            div.style.textAlign = 'center';
            div.innerHTML = `
                <img src="${sigDataUrl}" class="signature-thumbnail" />
                <button class="btn ghost small" style="color:#dc2626; display:block; margin: 4px auto;" onclick="deleteSignature(${i})">Delete</button>
            `;
            container.appendChild(div);
            select.innerHTML += `<option value="${i}">Signature ${i+1}</option>`;
        });
        select.value = sup.defaultSignatureIndex ?? -1;
    }
    function addSignature(file){
        if(!file) return;
        const sup = suppliers[currentSupplierIndex];
        if(!sup) return;
        if((sup.signatures || []).length >= 4) {
            alert('You can only store a maximum of 4 signatures.');
            return;
        }
        const reader = new FileReader();
        reader.onload = () => {
            if(!sup.signatures) sup.signatures = [];
            sup.signatures.push(reader.result);
            store.set('suppliers', suppliers);
            renderSupplierDashboard();
            document.getElementById('s-signature-upload').value = ''; // clear input
        };
        reader.readAsDataURL(file);
    }
    function deleteSignature(i){
        const sup = suppliers[currentSupplierIndex];
        if(!sup || !sup.signatures) return;
        if(!confirm('Are you sure you want to delete this signature?')) return;
        sup.signatures.splice(i, 1);
        if (sup.defaultSignatureIndex == i) {
          sup.defaultSignatureIndex = -1; // reset default if deleted
        } else if (sup.defaultSignatureIndex > i) {
          sup.defaultSignatureIndex -= 1; // adjust index
        }
        store.set('suppliers', suppliers);
        renderSupplierDashboard();
    }
    function setDefaultSignature(iStr){
        const i = parseInt(iStr);
        const sup = suppliers[currentSupplierIndex];
        if(!sup) return;
        sup.defaultSignatureIndex = i;
        store.set('suppliers', suppliers);
        renderSupplierDashboard();
    }

    // ===== Init =====
    function init(){
      if(sessionStorage.getItem('ok')==='1'){ routeTo('suppliers'); }
      else { routeTo('login'); }
    }
    init();
  </script>
</body>
</html>